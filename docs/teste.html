<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Three.js AR Cube Example</title>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
    <script>
        // WebXR configuration
        const xrSession = null;
        const SUPPORTED_FEATURES = ["local-floor"];

        // Renderer and scene setup
        const renderer = new THREE.WebGLRenderer({
            antialias: true
        });
        const scene = new THREE.Scene();

        // Initialize WebXR
        navigator.xr.isSessionSupported(SUPPORTED_FEATURES).then((supported) => {
            if (supported) {
                navigator.xr.requestSession(SUPPORTED_FEATURES).then((session) => {
                    xrSession = session;
                    const referenceSpace = xrSession.getReferenceSpace();
                    const glLayer = new XRWebGLLayer(xrSession, renderer);

                    // Create a cube
                    const geometry = new THREE.BoxGeometry();
                    const material = new THREE.MeshBasicMaterial({
                        color: 0x00ff00
                    });
                    const cube = new THREE.Mesh(geometry, material);
                    scene.add(cube);

                    session.addEventListener("end", () => xrSession = null);
                    xrSession.requestReferenceSpace("local-floor").then((refSpace) => {
                        referenceSpace = refSpace;
                        setupXRExperience(referenceSpace);
                    });
                });
            } else {
                alert("WebXR is not supported!");
            }
        });

        // Update the scene based on XR frame
        function updateXRFrame(time, frame) {
            if (!xrSession) return;

            const camera = frame.session.camera;
            camera.updateWorldMatrix(frame.session.viewerPose.transform.inverse);
            renderer.setAnimationLoop(render);
            render();
        }

        // Render function for animation loop
        function render() {
            renderer.render(scene, xrSession.currentFrame.camera);
        }

        // Setup XR experience
        function setupXRExperience(referenceSpace) {
            renderer.xr.setReferenceSpace(referenceSpace);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            xrSession.requestAnimationFrame(updateXRFrame);
        }
    </script>
</body>

</html>